<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SignalForge üî• - Job Signal Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-900 text-gray-100">
    <div x-data="dashboard()" x-init="init()" class="min-h-screen">
      <!-- Navigation -->
      <nav class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <h1 class="text-2xl font-bold text-orange-500">üî• SignalForge</h1>
              <span class="text-sm text-gray-400"
                >Real-time Job Signal Engine</span
              >
            </div>
            <div class="flex space-x-4">
              <button
                @click="currentView = 'dashboard'"
                :class="currentView === 'dashboard' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-home mr-2"></i>Dashboard
              </button>
              <button
                @click="currentView = 'jobs'"
                :class="currentView === 'jobs' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-briefcase mr-2"></i>Jobs
              </button>
              <button
                @click="currentView = 'trends'"
                :class="currentView === 'trends' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-chart-line mr-2"></i>Trends
              </button>
              <button
                @click="currentView = 'resume'"
                :class="currentView === 'resume' ? 'bg-orange-600' : 'bg-gray-700'"
                class="px-4 py-2 rounded-lg hover:bg-orange-500 transition"
              >
                <i class="fas fa-file-alt mr-2"></i>Resume
              </button>
              <button
                @click="triggerCollection()"
                class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-500 transition"
              >
                <i class="fas fa-sync-alt mr-2"></i>Collect
              </button>
            </div>
          </div>
        </div>
      </nav>

      <!-- Dashboard View -->
      <div
        x-show="currentView === 'dashboard'"
        class="container mx-auto px-4 py-8"
      >
        <h2 class="text-3xl font-bold mb-6">üìä Dashboard Overview</h2>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Total Jobs</p>
                <p
                  class="text-3xl font-bold text-blue-400"
                  x-text="stats.total_jobs"
                ></p>
              </div>
              <i class="fas fa-briefcase text-4xl text-blue-400"></i>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">High Score Jobs</p>
                <p
                  class="text-3xl font-bold text-green-400"
                  x-text="stats.high_score_count"
                ></p>
              </div>
              <i class="fas fa-star text-4xl text-green-400"></i>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Avg Score</p>
                <p
                  class="text-3xl font-bold text-purple-400"
                  x-text="stats.average_score?.toFixed(1) || '0'"
                ></p>
              </div>
              <i class="fas fa-chart-bar text-4xl text-purple-400"></i>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-400 text-sm">Remote Jobs</p>
                <p
                  class="text-3xl font-bold text-orange-400"
                  x-text="stats.remote_jobs || '0'"
                ></p>
              </div>
              <i class="fas fa-globe text-4xl text-orange-400"></i>
            </div>
          </div>
        </div>

        <!-- Recent High Score Jobs -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 class="text-xl font-bold mb-4">üî• Top Scoring Jobs</h3>
          <div class="space-y-4">
            <template x-for="job in topJobs" :key="job.id">
              <div
                class="bg-gradient-to-br from-gray-700 to-gray-750 rounded-lg p-5 hover:from-gray-600 hover:to-gray-650 transition-all duration-300 border border-gray-600 hover:border-orange-500 shadow-lg"
              >
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                      <h4
                        class="font-bold text-xl text-white"
                        x-text="job.title"
                      ></h4>
                      <span
                        class="px-2 py-1 rounded-full text-xs font-semibold"
                        :class="job.source === 'remoteok' ? 'bg-blue-600 text-blue-100' : 'bg-purple-600 text-purple-100'"
                        x-text="job.source"
                      ></span>
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-building text-orange-500 text-sm"></i>
                      <p
                        class="text-gray-300 font-medium"
                        x-text="job.company"
                      ></p>
                    </div>
                    <div
                      class="flex items-center space-x-4 text-sm text-gray-400"
                    >
                      <span>
                        <i
                          class="fas fa-map-marker-alt mr-1 text-orange-500"
                        ></i>
                        <span x-text="job.location"></span>
                      </span>
                      <span>
                        <i class="fas fa-clock mr-1 text-orange-500"></i>
                        <span x-text="formatDate(job.posted_at)"></span>
                      </span>
                    </div>
                  </div>
                  <div class="text-center min-w-[70px]">
                    <p
                      class="text-3xl font-black"
                      :class="job.score >= 70 ? 'text-green-400' : job.score >= 50 ? 'text-yellow-400' : 'text-gray-400'"
                      x-text="job.score"
                    ></p>
                    <p class="text-xs text-gray-400 uppercase">score</p>
                  </div>
                </div>

                <!-- Tech Stack -->
                <div x-show="job.stack && job.stack.length > 0" class="mb-3">
                  <div class="flex flex-wrap gap-2">
                    <template
                      x-for="tech in (Array.isArray(job.stack) ? job.stack.slice(0, 5) : job.stack.split(',').slice(0, 5))"
                      :key="tech"
                    >
                      <span
                        class="px-2 py-1 bg-gray-600 text-gray-200 rounded-full text-xs border border-gray-500"
                      >
                        <span x-text="tech.trim()"></span>
                      </span>
                    </template>
                  </div>
                </div>

                <!-- Description Preview -->
                <div x-show="job.description" class="mb-3">
                  <p
                    class="text-gray-300 text-sm leading-relaxed"
                    x-text="job.description ? job.description.substring(0, 150) + '...' : ''"
                  ></p>
                </div>

                <!-- Action Button -->
                <div class="flex justify-end">
                  <a
                    :href="job.url"
                    target="_blank"
                    class="px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 rounded-lg hover:from-orange-500 hover:to-orange-400 transition-all duration-300 font-semibold shadow-lg hover:shadow-orange-500/50"
                  >
                    <i class="fas fa-external-link-alt mr-2"></i>View Full Job
                  </a>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Jobs View -->
      <div x-show="currentView === 'jobs'" class="container mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-3xl font-bold">üíº All Jobs</h2>

          <!-- Filter Dropdown Menu -->
          <div class="relative" x-data="{ showFilters: false }">
            <button
              @click="showFilters = !showFilters"
              class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition flex items-center space-x-2"
            >
              <i class="fas fa-filter"></i>
              <span>Filters</span>
              <span
                x-show="filters.search || filters.minScore > 0 || filters.source || filters.location || filters.company"
                class="px-2 py-0.5 bg-orange-600 rounded-full text-xs"
                x-text="(filters.search ? 1 : 0) + (filters.minScore > 0 ? 1 : 0) + (filters.source ? 1 : 0) + (filters.location ? 1 : 0) + (filters.company ? 1 : 0)"
              ></span>
              <i
                class="fas fa-chevron-down text-sm"
                :class="showFilters ? 'rotate-180' : ''"
              ></i>
            </button>

            <!-- Dropdown Panel -->
            <div
              x-show="showFilters"
              @click.away="showFilters = false"
              x-transition
              class="absolute right-0 mt-2 w-96 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 p-4"
            >
              <div class="space-y-4">
                <!-- Search -->
                <div>
                  <label class="block text-sm text-gray-400 mb-2">
                    <i class="fas fa-search mr-2"></i>Search Keywords
                  </label>
                  <input
                    type="text"
                    x-model="filters.search"
                    @input="fetchJobs()"
                    placeholder="e.g., Python, React, Senior..."
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500"
                  />
                </div>

                <!-- Source Filter -->
                <div>
                  <label class="block text-sm text-gray-400 mb-2">
                    <i class="fas fa-globe mr-2"></i>Job Source
                  </label>
                  <select
                    x-model="filters.source"
                    @change="fetchJobs()"
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500"
                  >
                    <option value="">All Sources</option>
                    <option value="remoteok">RemoteOK</option>
                    <option value="linkedin">LinkedIn</option>
                  </select>
                </div>

                <!-- Score Filter -->
                <div>
                  <label class="block text-sm text-gray-400 mb-2">
                    <i class="fas fa-star mr-2"></i>Minimum Score
                  </label>
                  <select
                    x-model.number="filters.minScore"
                    @change="fetchJobs()"
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500"
                  >
                    <option :value="0">All Scores</option>
                    <option :value="50">50+ (Good Match)</option>
                    <option :value="60">60+ (Great Match)</option>
                    <option :value="70">70+ (Excellent Match)</option>
                    <option :value="80">80+ (Perfect Match)</option>
                  </select>
                </div>

                <!-- Location Filter -->
                <div>
                  <label class="block text-sm text-gray-400 mb-2">
                    <i class="fas fa-map-marker-alt mr-2"></i>Location
                  </label>
                  <input
                    type="text"
                    x-model="filters.location"
                    @input="fetchJobs()"
                    placeholder="e.g., Remote, New York..."
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500"
                  />
                </div>

                <!-- Company Filter -->
                <div>
                  <label class="block text-sm text-gray-400 mb-2">
                    <i class="fas fa-building mr-2"></i>Company
                  </label>
                  <input
                    type="text"
                    x-model="filters.company"
                    @input="fetchJobs()"
                    placeholder="e.g., Google, Microsoft..."
                    class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500"
                  />
                </div>

                <!-- Actions -->
                <div class="flex space-x-2 pt-2 border-t border-gray-700">
                  <button
                    @click="clearFilters(); showFilters = false"
                    class="flex-1 px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition"
                  >
                    <i class="fas fa-times mr-2"></i>Clear All
                  </button>
                  <button
                    @click="showFilters = false"
                    class="flex-1 px-4 py-2 bg-orange-600 rounded-lg hover:bg-orange-500 transition"
                  >
                    <i class="fas fa-check mr-2"></i>Apply
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
          <template x-for="job in jobs" :key="job.id">
            <div
              class="bg-gradient-to-br from-gray-800 to-gray-850 rounded-xl p-6 border-2 border-gray-700 hover:border-orange-500 transition-all duration-300 shadow-lg hover:shadow-orange-500/20"
            >
              <!-- Header Section -->
              <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                  <div class="flex items-center flex-wrap gap-3 mb-2">
                    <h3
                      class="text-2xl font-bold text-white"
                      x-text="job.title"
                    ></h3>
                    <span
                      class="px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide"
                      :class="job.source === 'remoteok' ? 'bg-blue-600 text-blue-100' : 'bg-purple-600 text-purple-100'"
                      x-text="job.source"
                    ></span>
                  </div>
                  <div class="flex items-center space-x-2 mb-3">
                    <i class="fas fa-building text-orange-500"></i>
                    <p
                      class="text-lg text-gray-200 font-medium"
                      x-text="job.company"
                    ></p>
                  </div>
                </div>
                <!-- Score Badge -->
                <div class="text-center min-w-[80px]">
                  <div
                    class="text-4xl font-black mb-1"
                    :class="job.score >= 70 ? 'text-green-400' : job.score >= 50 ? 'text-yellow-400' : 'text-gray-400'"
                    x-text="job.score"
                  ></div>
                  <div class="text-xs text-gray-400 uppercase tracking-wider">
                    Score
                  </div>
                </div>
              </div>

              <!-- Info Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <div class="flex items-center space-x-2 text-gray-300">
                  <i class="fas fa-map-marker-alt text-orange-500 w-4"></i>
                  <span class="font-medium" x-text="job.location"></span>
                </div>
                <div class="flex items-center space-x-2 text-gray-300">
                  <i class="fas fa-clock text-orange-500 w-4"></i>
                  <span x-text="formatDate(job.posted_at)"></span>
                </div>
              </div>

              <!-- Tech Stack -->
              <div x-show="job.stack && job.stack.length > 0" class="mb-4">
                <div class="flex items-center space-x-2 mb-2">
                  <i class="fas fa-code text-orange-500"></i>
                  <span
                    class="text-sm text-gray-400 font-semibold uppercase tracking-wide"
                    >Tech Stack</span
                  >
                </div>
                <div class="flex flex-wrap gap-2">
                  <template
                    x-for="tech in (Array.isArray(job.stack) ? job.stack : job.stack.split(','))"
                    :key="tech"
                  >
                    <span
                      class="px-3 py-1 bg-gray-700 text-gray-200 rounded-full text-sm font-medium border border-gray-600 hover:border-orange-500 transition"
                    >
                      <span x-text="tech.trim()"></span>
                    </span>
                  </template>
                </div>
              </div>

              <!-- Description -->
              <div x-show="job.description" class="mb-4">
                <div class="flex items-center space-x-2 mb-2">
                  <i class="fas fa-file-alt text-orange-500"></i>
                  <span
                    class="text-sm text-gray-400 font-semibold uppercase tracking-wide"
                    >Description</span
                  >
                </div>
                <div
                  class="text-gray-300 leading-relaxed bg-gray-900/50 rounded-lg p-4 border border-gray-700"
                  x-html="job.description ? job.description.substring(0, 500) + (job.description.length > 500 ? '...' : '') : 'No description available'"
                ></div>
              </div>

              <!-- Action Button -->
              <div class="flex justify-end">
                <a
                  :href="job.url"
                  target="_blank"
                  class="px-6 py-3 bg-gradient-to-r from-orange-600 to-orange-500 rounded-lg hover:from-orange-500 hover:to-orange-400 transition-all duration-300 font-semibold text-white shadow-lg hover:shadow-orange-500/50 transform hover:scale-105"
                >
                  <i class="fas fa-external-link-alt mr-2"></i>View Full Job
                </a>
              </div>
            </div>
          </template>
        </div>

        <div x-show="jobs.length === 0" class="text-center py-12 text-gray-400">
          <i class="fas fa-inbox text-6xl mb-4"></i>
          <p class="text-xl">
            No jobs found. Try adjusting your filters or collect new jobs.
          </p>
        </div>
      </div>

      <!-- Trends View -->
      <div
        x-show="currentView === 'trends'"
        class="container mx-auto px-4 py-8"
      >
        <h2 class="text-3xl font-bold mb-6">üìà Market Trends</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Top Keywords -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üîù Trending Keywords</h3>
            <div class="space-y-2">
              <template
                x-for="[keyword, count] in trends.trending_keywords || []"
                :key="keyword"
              >
                <div class="flex items-center justify-between">
                  <span class="capitalize" x-text="keyword"></span>
                  <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-700 rounded-full h-2">
                      <div
                        class="bg-orange-500 h-2 rounded-full"
                        :style="`width: ${(count / (trends.trending_keywords?.[0]?.[1] || 1)) * 100}%`"
                      ></div>
                    </div>
                    <span
                      class="text-orange-400 font-semibold w-8 text-right"
                      x-text="count"
                    ></span>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Top Technologies -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üíª Top Technologies</h3>
            <div class="space-y-2">
              <template
                x-for="[tech, count] in (trends.top_technologies || []).slice(0, 10)"
                :key="tech"
              >
                <div class="flex items-center justify-between">
                  <span class="capitalize" x-text="tech"></span>
                  <div class="flex items-center space-x-2">
                    <div class="w-32 bg-gray-700 rounded-full h-2">
                      <div
                        class="bg-blue-500 h-2 rounded-full"
                        :style="`width: ${(count / (trends.top_technologies?.[0]?.[1] || 1)) * 100}%`"
                      ></div>
                    </div>
                    <span
                      class="text-blue-400 font-semibold w-8 text-right"
                      x-text="count"
                    ></span>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Top Companies -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üè¢ Top Hiring Companies</h3>
            <div class="space-y-2">
              <template
                x-for="[company, count] in trends.top_hiring_companies || []"
                :key="company"
              >
                <div class="flex items-center justify-between">
                  <span x-text="company"></span>
                  <span
                    class="text-green-400 font-semibold"
                    x-text="count + ' positions'"
                  ></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Top Locations -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">üìç Top Locations</h3>
            <div class="space-y-2">
              <template
                x-for="[location, count] in trends.top_locations || []"
                :key="location"
              >
                <div class="flex items-center justify-between">
                  <span x-text="location"></span>
                  <span
                    class="text-purple-400 font-semibold"
                    x-text="count + ' jobs'"
                  ></span>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Summary Stats -->
        <div class="mt-6 bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h3 class="text-xl font-bold mb-4">üìä Analysis Summary</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p class="text-gray-400 text-sm">Total Analyzed</p>
              <p
                class="text-2xl font-bold text-blue-400"
                x-text="trends.total_jobs_analyzed || 0"
              ></p>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Recent Jobs (3d)</p>
              <p
                class="text-2xl font-bold text-green-400"
                x-text="trends.recent_job_count || 0"
              ></p>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Unique Companies</p>
              <p
                class="text-2xl font-bold text-purple-400"
                x-text="(trends.top_hiring_companies || []).length"
              ></p>
            </div>
            <div>
              <p class="text-gray-400 text-sm">Last Updated</p>
              <p
                class="text-sm text-orange-400"
                x-text="formatDate(trends.analysis_timestamp)"
              ></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Resume View -->
      <div
        x-show="currentView === 'resume'"
        class="container mx-auto px-4 py-8"
      >
        <h2 class="text-3xl font-bold mb-6">üìÑ Resume-Based Scoring</h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Resume Upload/Input -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">Upload Your Resume</h3>
            <p class="text-gray-400 mb-4">
              Upload a PDF/TXT file or paste your resume text to personalize job
              scoring
            </p>

            <!-- File Upload -->
            <div class="mb-4">
              <label class="block text-sm text-gray-400 mb-2">
                <i class="fas fa-file-upload mr-2"></i>Upload Resume File (PDF,
                TXT, DOCX)
              </label>
              <div class="flex items-center space-x-4">
                <label
                  class="flex-1 px-4 py-3 bg-gray-700 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:border-orange-500 transition"
                >
                  <div class="text-center">
                    <i
                      class="fas fa-cloud-upload-alt text-3xl text-gray-500 mb-2"
                    ></i>
                    <p class="text-sm text-gray-400">
                      <span class="text-orange-400">Click to upload</span> or
                      drag and drop
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                      PDF, TXT, DOCX (max 5MB)
                    </p>
                  </div>
                  <input
                    type="file"
                    @change="handleFileUpload($event)"
                    accept=".pdf,.txt,.doc,.docx"
                    class="hidden"
                  />
                </label>
              </div>
              <p x-show="uploadedFileName" class="text-sm text-green-400 mt-2">
                <i class="fas fa-check-circle mr-1"></i>
                <span x-text="uploadedFileName"></span>
              </p>
            </div>

            <!-- Text Area -->
            <div>
              <label class="block text-sm text-gray-400 mb-2">
                <i class="fas fa-keyboard mr-2"></i>Or Paste Resume Text
              </label>
              <textarea
                x-model="resumeText"
                placeholder="Paste your resume or list your skills (e.g., Python, React, AWS, Machine Learning...)"
                class="w-full h-48 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500 text-gray-100 resize-none"
              ></textarea>
            </div>

            <div class="mt-4 flex space-x-4">
              <button
                @click="analyzeResume()"
                class="flex-1 px-6 py-3 bg-orange-600 rounded-lg hover:bg-orange-500 transition font-semibold"
              >
                <i class="fas fa-brain mr-2"></i>Analyze Resume
              </button>
              <button
                @click="clearResume()"
                class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition"
              >
                <i class="fas fa-trash mr-2"></i>Clear
              </button>
            </div>
          </div>

          <!-- Extracted Skills -->
          <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-xl font-bold mb-4">Extracted Skills & Keywords</h3>

            <div
              x-show="!resumeSkills.length"
              class="text-center py-12 text-gray-400"
            >
              <i class="fas fa-inbox text-6xl mb-4"></i>
              <p>No skills extracted yet. Add your resume to get started.</p>
            </div>

            <div x-show="resumeSkills.length" class="space-y-4">
              <div>
                <p class="text-sm text-gray-400 mb-2">Technical Skills:</p>
                <div class="flex flex-wrap gap-2">
                  <template x-for="skill in resumeSkills" :key="skill">
                    <span
                      class="px-3 py-1 bg-orange-600 rounded-full text-sm"
                      x-text="skill"
                    ></span>
                  </template>
                </div>
              </div>

              <div class="mt-4 p-4 bg-gray-700 rounded-lg">
                <p class="text-sm text-gray-400 mb-2">üéØ Scoring Impact:</p>
                <p class="text-gray-300">
                  Jobs matching your skills will receive
                  <span class="text-orange-400 font-bold"
                    >+20 bonus points</span
                  >
                </p>
                <p class="text-sm text-gray-400 mt-2">
                  Threshold updated: Jobs scoring
                  <span class="text-green-400 font-bold">60+</span> will trigger
                  alerts
                </p>
              </div>

              <button
                @click="rescoreAllJobs()"
                class="w-full px-6 py-3 bg-green-600 rounded-lg hover:bg-green-500 transition font-semibold"
              >
                <i class="fas fa-sync-alt mr-2"></i>Re-score All Jobs with
                Resume
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div
        x-show="loading"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-gray-800 rounded-lg p-8 text-center">
          <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-4"></i>
          <p class="text-xl">Loading...</p>
        </div>
      </div>

      <!-- Toast Notification -->
      <div
        x-show="toast.show"
        x-transition
        class="fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg p-4 shadow-lg z-50 max-w-md"
      >
        <div class="flex items-center space-x-3">
          <i
            :class="toast.type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-circle text-red-400'"
            class="text-2xl"
          ></i>
          <p x-text="toast.message"></p>
        </div>
      </div>
    </div>

    <script>
      function dashboard() {
        return {
          currentView: "dashboard",
          loading: false,
          stats: {},
          jobs: [],
          topJobs: [],
          trends: {},
          filters: {
            search: "",
            minScore: 0,
            source: "",
            location: "",
            company: "",
          },
          toast: {
            show: false,
            message: "",
            type: "success",
          },
          apiBaseUrl: "http://localhost:8000",
          resumeText: "",
          resumeSkills: [],
          uploadedFileName: "",

          async init() {
            // Load saved resume if exists
            const savedResume = localStorage.getItem("signalforge_resume");
            if (savedResume) {
              this.resumeText = savedResume;
              this.analyzeResume();
            }

            await this.fetchStats();
            await this.fetchJobs();
            await this.fetchTrends();
          },

          async fetchStats() {
            try {
              const response = await fetch(
                `${this.apiBaseUrl}/api/jobs/stats/summary`,
              );
              this.stats = await response.json();
            } catch (error) {
              console.error("Error fetching stats:", error);
            }
          },

          async fetchJobs() {
            this.loading = true;
            try {
              let url = `${this.apiBaseUrl}/api/jobs?limit=100`;
              if (this.filters.minScore > 0) {
                url += `&min_score=${this.filters.minScore}`;
              }
              if (this.filters.source) {
                url += `&source=${this.filters.source}`;
              }
              if (this.filters.location) {
                url += `&location=${encodeURIComponent(this.filters.location)}`;
              }
              if (this.filters.company) {
                url += `&company=${encodeURIComponent(this.filters.company)}`;
              }

              const response = await fetch(url);
              const data = await response.json();
              this.jobs = data.jobs || [];

              // Apply client-side search filter
              if (this.filters.search) {
                const searchLower = this.filters.search.toLowerCase();
                this.jobs = this.jobs.filter(
                  (job) =>
                    job.title.toLowerCase().includes(searchLower) ||
                    job.company.toLowerCase().includes(searchLower) ||
                    (job.stack &&
                      job.stack.toLowerCase().includes(searchLower)),
                );
              }

              // Apply resume scoring if available
              if (this.resumeSkills.length > 0) {
                this.jobs = this.jobs.map((job) =>
                  this.scoreJobWithResume(job),
                );
                this.jobs.sort((a, b) => b.score - a.score);
              }

              this.topJobs = this.jobs.slice(0, 5);
            } catch (error) {
              console.error("Error fetching jobs:", error);
              this.showToast("Error fetching jobs", "error");
            } finally {
              this.loading = false;
            }
          },

          async fetchTrends() {
            try {
              // Call a new endpoint or compute trends from jobs
              this.trends = this.computeTrends(this.jobs);
            } catch (error) {
              console.error("Error fetching trends:", error);
            }
          },

          computeTrends(jobs) {
            const keywords = {};
            const companies = {};
            const locations = {};
            const techs = {};

            jobs.forEach((job) => {
              // Count companies
              companies[job.company] = (companies[job.company] || 0) + 1;

              // Count locations
              locations[job.location] = (locations[job.location] || 0) + 1;

              // Count tech stack
              if (job.stack) {
                let stackItems = [];
                if (typeof job.stack === "string") {
                  stackItems = job.stack.split(",");
                } else if (Array.isArray(job.stack)) {
                  stackItems = job.stack;
                }

                stackItems.forEach((tech) => {
                  const t = String(tech).trim().toLowerCase();
                  if (t) techs[t] = (techs[t] || 0) + 1;
                });
              }
            });

            return {
              trending_keywords: Object.entries(keywords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              top_technologies: Object.entries(techs)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              top_hiring_companies: Object.entries(companies)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              top_locations: Object.entries(locations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10),
              total_jobs_analyzed: jobs.length,
              recent_job_count: jobs.filter((j) => {
                const posted = new Date(j.posted_at);
                const threeDaysAgo = new Date();
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                return posted >= threeDaysAgo;
              }).length,
              analysis_timestamp: new Date().toISOString(),
            };
          },

          async triggerCollection() {
            this.loading = true;
            this.showToast("Starting job collection...", "success");

            try {
              // In a real app, this would trigger the collector
              await new Promise((resolve) => setTimeout(resolve, 2000));
              this.showToast(
                "Collection completed! Refreshing data...",
                "success",
              );
              await this.init();
            } catch (error) {
              this.showToast("Collection failed", "error");
            } finally {
              this.loading = false;
            }
          },

          formatDate(dateStr) {
            if (!dateStr) return "N/A";
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
          },

          showToast(message, type = "success") {
            this.toast = { show: true, message, type };
            setTimeout(() => {
              this.toast.show = false;
            }, 3000);
          },

          viewJobDetails(job) {
            window.open(job.url, "_blank");
          },

          clearFilters() {
            this.filters = {
              search: "",
              minScore: 0,
              source: "",
              location: "",
              company: "",
            };
            this.fetchJobs();
            this.showToast("Filters cleared", "success");
          },

          // Resume file upload handler
          async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              this.showToast("File size must be less than 5MB", "error");
              return;
            }

            this.uploadedFileName = file.name;
            this.loading = true;

            try {
              const text = await this.extractTextFromFile(file);
              this.resumeText = text;
              this.showToast(
                `File "${file.name}" uploaded successfully!`,
                "success",
              );

              // Auto-analyze after upload
              setTimeout(() => this.analyzeResume(), 500);
            } catch (error) {
              this.showToast(
                "Error reading file. Please try a different format.",
                "error",
              );
              console.error("File upload error:", error);
            } finally {
              this.loading = false;
            }
          },

          async extractTextFromFile(file) {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();

              reader.onload = (e) => {
                const text = e.target.result;

                // For PDF files, we'll get binary data, so just use basic text extraction
                if (file.type === "application/pdf") {
                  // Basic PDF text extraction (for better results, would need pdf.js library)
                  resolve(text);
                } else {
                  // For TXT and other text-based files
                  resolve(text);
                }
              };

              reader.onerror = () => reject(new Error("Failed to read file"));

              // Read as text for TXT, DOC files
              if (file.type.includes("text") || file.name.endsWith(".txt")) {
                reader.readAsText(file);
              } else {
                // For PDFs and other formats, read as text (basic extraction)
                reader.readAsText(file);
              }
            });
          },

          // Resume-based scoring methods
          analyzeResume() {
            if (!this.resumeText.trim()) {
              this.showToast("Please enter your resume text", "error");
              return;
            }

            // Extract skills from resume
            const text = this.resumeText.toLowerCase();
            const techKeywords = [
              "python",
              "javascript",
              "typescript",
              "java",
              "go",
              "rust",
              "c++",
              "c#",
              "react",
              "vue",
              "angular",
              "node",
              "django",
              "flask",
              "fastapi",
              "aws",
              "azure",
              "gcp",
              "docker",
              "kubernetes",
              "terraform",
              "postgresql",
              "mysql",
              "mongodb",
              "redis",
              "elasticsearch",
              "machine learning",
              "ml",
              "ai",
              "data science",
              "deep learning",
              "devops",
              "ci/cd",
              "jenkins",
              "github actions",
              "agile",
              "scrum",
              "rest api",
              "graphql",
              "microservices",
            ];

            this.resumeSkills = techKeywords.filter((keyword) =>
              text.includes(keyword),
            );

            // Save to localStorage
            localStorage.setItem("signalforge_resume", this.resumeText);
            localStorage.setItem(
              "signalforge_skills",
              JSON.stringify(this.resumeSkills),
            );

            this.showToast(
              `Extracted ${this.resumeSkills.length} skills from your resume!`,
              "success",
            );

            // Re-fetch and re-score jobs
            this.fetchJobs();
          },

          clearResume() {
            this.resumeText = "";
            this.resumeSkills = [];
            this.uploadedFileName = "";
            localStorage.removeItem("signalforge_resume");
            localStorage.removeItem("signalforge_skills");
            this.showToast("Resume cleared", "success");
            this.fetchJobs();
          },

          scoreJobWithResume(job) {
            if (!this.resumeSkills.length) return job;

            // Create a copy of the job
            const scoredJob = { ...job };
            let bonusPoints = 0;

            // Check title and description for skill matches
            const jobText = `${job.title} ${job.stack || ""}`.toLowerCase();

            const matchedSkills = this.resumeSkills.filter((skill) =>
              jobText.includes(skill.toLowerCase()),
            );

            // Add bonus points: 2 points per matched skill (max 20 points)
            bonusPoints = Math.min(matchedSkills.length * 2, 20);

            scoredJob.score = Math.min(job.score + bonusPoints, 100);
            scoredJob.resumeMatch = matchedSkills.length > 0;
            scoredJob.matchedSkills = matchedSkills;

            return scoredJob;
          },

          async rescoreAllJobs() {
            if (!this.resumeSkills.length) {
              this.showToast("Please analyze your resume first", "error");
              return;
            }

            this.showToast(
              "Re-scoring all jobs with your resume...",
              "success",
            );
            await this.fetchJobs();
            this.currentView = "jobs";
          },

          viewJobDetails(job) {
            window.open(job.url, "_blank");
          },
        };
      }
    </script>
  </body>
</html>
